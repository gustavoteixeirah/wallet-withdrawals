# Database Schema: `wallet_withdrawals`

This document outlines the database schema for the `wallet_withdrawals` service. The core of the schema is a single
table, `wallet_withdrawals.wallet_withdrawals`, which is designed to store the state and details of every wallet
withdrawal request.

## Table: `wallet_withdrawals.wallet_withdrawals`

This table acts as the primary data store for the `WalletWithdraw` aggregate. It tracks the entire lifecycle of a
withdrawal from its creation to its final state (completed or failed).

### SQL Definition

```sql
CREATE SCHEMA IF NOT EXISTS wallet_withdrawals;

CREATE TABLE wallet_withdrawals.wallet_withdrawals
(
    id                        UUID PRIMARY KEY,
    user_id                   BIGINT         NOT NULL,
    status                    VARCHAR(32)    NOT NULL,
    amount                    DECIMAL(19, 4) NOT NULL,
    fee                       DECIMAL(19, 4) NOT NULL,
    amount_for_recipient      DECIMAL(19, 4) NOT NULL,
    created_at                TIMESTAMPTZ    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at                TIMESTAMPTZ    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    failure_reason            TEXT,
    wallet_transaction_id_ref VARCHAR(255),
    payment_provider_id_ref   VARCHAR(255),
    recipient_first_name      VARCHAR(255)   NOT NULL,
    recipient_last_name       VARCHAR(255)   NOT NULL,
    recipient_national_id     VARCHAR(255)   NOT NULL,
    recipient_account_number  VARCHAR(255)   NOT NULL,
    recipient_routing_number  VARCHAR(255)   NOT NULL
); 
```

-----

### Column Explanations

| Column                      | Type             | Constraints   | Explanation                                                                                                                                                                                                                   |
|:----------------------------|:-----------------|:--------------|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `id`                        | `UUID`           | `PRIMARY KEY` | The unique identifier for the withdrawal aggregate. This ID is generated by the application upon creation.                                                                                                                    |
| `user_id`                   | `BIGINT`         | `NOT NULL`    | The ID of the user who initiated the withdrawal request.                                                                                                                                                                      |
| `status`                    | `VARCHAR(32)`    | `NOT NULL`    | The current state of the withdrawal. This column is updated as the aggregate moves through its lifecycle. Possible values are defined by the `WalletWithdrawStatus` enum: `CREATED`, `WALLET_DEBITED`, `COMPLETED`, `FAILED`. |
| `amount`                    | `DECIMAL(19, 4)` | `NOT NULL`    | The original gross amount the user requested to withdraw, *before* any fees are applied.                                                                                                                                      |
| `fee`                       | `DECIMAL(19, 4)` | `NOT NULL`    | The calculated fee for the transaction. This is calculated on creation as a percentage (10%) of the `amount`.                                                                                                                 |
| `amount_for_recipient`      | `DECIMAL(19, 4)` | `NOT NULL`    | The net amount that will be sent to the recipient (`amount` - `fee`).                                                                                                                                                         |
| `created_at`                | `TIMESTAMPTZ`    | `NOT NULL`    | Timestamp of when the withdrawal request was first created in the system.                                                                                                                                                     |
| `updated_at`                | `TIMESTAMPTZ`    | `NOT NULL`    | Timestamp that is updated every time the record is saved, reflecting the last modification (e.g., a status change).                                                                                                           |
| `failure_reason`            | `TEXT`           | `NULL`        | If the `status` becomes `FAILED`, this column stores a human-readable reason for the failure. This can be set during the debit step (e.g., "Insufficient funds" ) or the payment step (e.g., "Payment rejected" ).            |
| `wallet_transaction_id_ref` | `VARCHAR(255)`   | `NULL`        | An external identifier. This stores the transaction ID returned by the `WalletServicePort` after the user's wallet has been successfully debited.                                                                             |
| `payment_provider_id_ref`   | `VARCHAR(255)`   | `NULL`        | An external identifier. This stores the payment receipt or reference ID returned by the `PaymentProviderPort` after the payment to the recipient has been successfully processed.                                             |
| `recipient_first_name`      | `VARCHAR(255)`   | `NOT NULL`    | (Denormalized) The first name of the recipient.                                                                                                                                                                               |
| `recipient_last_name`       | `VARCHAR(255)`   | `NOT NULL`    | (Denormalized) The last name of the recipient.                                                                                                                                                                                |
| `recipient_national_id`     | `VARCHAR(255)`   | `NOT NULL`    | (Denormalized) The national identification number of the recipient.                                                                                                                                                           |
| `recipient_account_number`  | `VARCHAR(255)`   | `NOT NULL`    | (Denormalized) The bank account number of the recipient.                                                                                                                                                                      |
| `recipient_routing_number`  | `VARCHAR(255)`   | `NOT NULL`    | (Denormalized) The bank routing number for the recipient's account.                                                                                                                                                           |

**Note on Denormalization:** The `recipient_` columns are a denormalized snapshot of the `Recipient`  and `Account`
value objects at the time of the transaction. This is a deliberate design choice to ensure that the withdrawal record
remains accurate and immutable, even if the recipient's details change in another part of the system later.